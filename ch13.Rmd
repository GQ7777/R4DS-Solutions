---
title: "Ch13"
output:
  html_document:
    df_print: paged
---

## Exercises 16.2.4
What happens if you parse a string that contains invalid dates?

```{r}
ymd(c("2010-10-10", "bananas"))
```
It retuns the parsed object as a Date object (so it parses it) but returns the failed string as NA.

What does the tzone argument to today() do? Why is it important?

```{r}

# It gives the date of the specific time zone. If you're in China, the date might be different than from the U.S at a given moment.

# Check OlsonNames()
# for al TZ names
tz <- str_subset(OlsonNames(), "Madrid")
today(tzone = tz)
```


Use the appropriate lubridate function to parse each of the following dates:

```{r}

d1 <- "January 1, 2010"

mdy(d1)

d2 <- "2015-Mar-07"

ymd(d2)

d3 <- "06-Jun-2017"

dmy(d3)

d4 <- c("August 19 (2015)", "July 1 (2015)")

mdy(d4)

d5 <- "12/30/14" # Dec 30, 2014

mdy(d5)

```

## Exercises 16.3.4
How does the distribution of flight times within a day change over the course of the year?

```{r}
make_datetime_100 <- function(year, month, day, time) {
  make_datetime(year, month, day, time %/% 100, time %% 100,
                tz = "Europe/Madrid")
}

flights_dt <-
  flights %>%
  filter(!is.na(dep_time), !is.na(arr_time)) %>%
  mutate(dep_time = make_datetime_100(year, month, day, dep_time),
         arr_time = make_datetime_100(year, month, day, arr_time),
         sched_dep_time = make_datetime_100(
           year, month, day, sched_dep_time
         ),
         sched_arr_time = make_datetime_100(
           year, month, day, sched_arr_time
         )) %>%
  select(origin, dest, ends_with("delay"), ends_with("time"))


flights_dt %>%
  mutate(day = yday(dep_time)) %>%
  filter(day == 1) %>%
  ggplot(aes(dep_time)) +
  geom_freqpoly()

```


Compare dep_time, sched_dep_time and dep_delay. Are they consistent? Explain your findings.

```{r}
flights_dt %>%
  select(dep_time, sched_dep_time, dep_delay) %>%
  mutate(diff = (dep_time - sched_dep_time) %>% seconds_to_period() %>% minute()) %>%
  filter(dep_delay != diff) %>%
  View()
```
There seems to be a discrepancy for flights that flew from one day to another.

Compare air_time with the duration between the departure and arrival. Explain your findings. (Hint: consider the location of the airport.)

```{r}

```


How does the average delay time change over the course of a day? Should you use dep_time or sched_dep_time? Why?

```{r}
flights_dt %>%
  group_by(minute = minute(dep_time)) %>%
  summarize(avg_delay = mean(dep_delay)) %>%
  ggplot(aes(minute, avg_delay)) +
  geom_line()

flights_dt %>%
  group_by(minute = minute(sched_dep_time)) %>%
  summarize(avg_delay = mean(dep_delay)) %>%
  ggplot(aes(minute, avg_delay)) +
  geom_line()
```

`dep_time` because it shows the real pattern of delays. The scheduled departure time shows no pattern over the day.

On what day of the week should you leave if you want to minimise the chance of a delay?

```{r}
flights_dt %>%
  group_by(day = wday(dep_time, label = TRUE, week_start = 1)) %>%
  summarize(avg_delay = mean(dep_delay)) %>%
  ggplot(aes(day, avg_delay)) +
  geom_line(aes(group = 1)) +
  geom_point()
```

Saturday!

What makes the distribution of diamonds$carat and flights$sched_dep_time similar?

```{r}
ggplot(diamonds, aes(carat %% 1 * 100)) +
  geom_histogram(bins = 100)
```

```{r}
ggplot(flights_dt, aes(minute(sched_dep_time))) +
  geom_histogram(bins = 100)
```


Confirm my hypothesis that the early departures of flights in minutes 20-30 and 50-60 are caused by scheduled flights that leave early. Hint: create a binary variable that tells you whether or not a flight was delayed.